# CQ3: Which nutrient concentrations in cell line K are most associated with viable cell density above Z at day 6 of culture?
#
# Finds (e.g., glutamine) nutrient concentrations in culture medium associated with high viable cell density in cell line K at day 6.
# Parameters: cell line (K), minimum viable cell density threshold (Z)
#
# Requirements:
#   - Cell culture processes with CellCultureSystem and CultureMedium/nutrient concentrations
#   - Samples collected at day 6 with viability measurements
#   - (Optional) Filter by cell line
#
# Note: Returns 0 rows if data lacks NutrientConcentration or CellViabilityMeasurement instances.

PREFIX mcbo: <http://example.org/mcbo#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX ro: <http://purl.obolibrary.org/obo/RO_>
PREFIX bfo: <http://purl.obolibrary.org/obo/BFO_>

SELECT ?cellLine ?nutrientType ?concentrationValue ?concentrationUnit ?viableCellDensity ?collectionDay
WHERE {
  # Start with the smallest set: viability measurements (only ~8 in real data)
  ?viability a mcbo:CellViabilityMeasurement ;
             mcbo:hasViableCellDensity ?viableCellDensity .
  
  # Find samples with this viability at day 6
  ?sample mcbo:hasCellViabilityMeasurement ?viability ;
          mcbo:hasCollectionDay ?collectionDay .
  FILTER(?collectionDay = 6)
  
  # Link sample to process
  ?process mcbo:hasProcessOutput ?sample .
  OPTIONAL { ?process mcbo:usesCellLine ?cellLine . }
  
  # Link process to culture system with medium
  ?process ro:0000057 ?system .
  ?system a mcbo:CellCultureSystem ;
          bfo:0000051 ?medium .
  
  # Get nutrient concentrations from medium
  ?medium mcbo:hasNutrientConcentration ?nutrient .
  ?nutrient mcbo:hasConcentrationValue ?concentrationValue ;
            mcbo:hasConcentrationUnit ?concentrationUnit .
  OPTIONAL { ?nutrient rdfs:label ?nutrientType }
}
ORDER BY DESC(?viableCellDensity) ?cellLine ?nutrientType

